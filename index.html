<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bac Master by Slinder</title>
<style>
:root{
--bg:#000;
--panel:#0c0c0c;
--muted:#9aa0a6;
--accent:#1db954;
--glass: rgba(255,255,255,0.02);
--cell-border: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#e6edf3;background:var(--bg)}
.app{max-width:1400px;margin:18px auto;padding:14px}
header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
header h1{font-size:20px;margin:0}
header p{margin:0;color:var(--muted);font-size:13px}
.controls{display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
.btn{background:var(--panel);border:1px solid var(--cell-border);padding:8px 12px;border-radius:8px;color:inherit;cursor:pointer}
.btn.ghost{background:transparent}
.btn.active{border-color:var(--accent);color:var(--accent)}
.tab-nav{display:flex;gap:8px;margin-bottom:12px;border-bottom:1px solid var(--cell-border);padding-bottom:8px}
.tab{padding:6px 12px;border-radius:6px;cursor:pointer}
.tab.active{background:var(--accent);color:#000}
.layout{display:flex;gap:12px}
/* Planner */
.planner{
  flex:1;
  background:linear-gradient(180deg,#0b0b0b,#0a0a0a);
  padding:0;
  border-radius:10px;
  border:1px solid var(--cell-border);
  min-width:0;
  display:flex;
  flex-direction:column;
}
/* Scrollable grid container */
.grid-container {
  overflow-x: auto;
  overflow-y: hidden;
  width:100%;
  border-radius:10px;
  border:1px solid var(--cell-border);
  box-shadow: inset 0 0 8px rgba(0,0,0,0.3);
  flex:1;
  min-height:0;
}
/* Grid */
.grid{
  display:grid;
  gap:1px;
  background:var(--cell-border);
  position:relative;
  min-width: fit-content;
  width: auto;
  transform-origin: top left;
  transition: transform 0.2s ease;
}
.cell{
  background:var(--glass);
  padding:4px 2px;
  font-size:10px;
  color:var(--muted);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
.header-cell{
  background:transparent;
  color:var(--muted);
  font-weight:600;
  font-size:11px;
}
.day-name{
  background:transparent;
  justify-content:flex-start;
  padding-left:14px;
  font-weight:700;
  font-size:13px;
}
.event{
  position:absolute;
  border-radius:6px;
  padding:4px 6px;
  font-weight:700;
  color:#050505;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(0,0,0,0.5);
  overflow:hidden;
  white-space:nowrap;
  text-overflow:ellipsis;
  font-size:12px;
}
.event small{
  display:block;
  font-weight:600;
  font-size:10px;
  opacity:0.9;
}
/* Sidebar */
.side{
  width:360px;
  min-width:260px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.panel{
  background:linear-gradient(180deg,#0b0b0b,#0e0e0e);
  padding:12px;
  border-radius:10px;
  border:1px solid var(--cell-border);
}
label{
  display:block;
  color:var(--muted);
  font-size:13px;
  margin-bottom:6px;
}
input[type=text],input[type=time],input[type=date],input[type=number],select{
  width:100%;
  padding:8px;
  border-radius:8px;
  border:1px solid var(--cell-border);
  background:#0a0a0a;
  color:#e6edf3;
}
input[type=date]::-webkit-calendar-picker-indicator,
input[type=time]::-webkit-calendar-picker-indicator {
  filter: invert(1);
  cursor: pointer;
}
.row{display:flex;gap:8px}
.small{flex:1}
.swatch{
  width:28px;
  height:28px;
  border-radius:6px;
  border:2px solid rgba(255,255,255,0.06);
  cursor:pointer;
}
.palette-list{
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-top:8px;
}
.pal-row{
  display:flex;
  align-items:center;
  gap:8px;
}
.pal-label{
  background:transparent;
  color:var(--muted);
  border:none;
  padding:6px;
  border-radius:6px;
}
.task-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--cell-border);position:relative}
.task-item:last-child{border-bottom:none}
.task-checkbox{width:18px;height:18px;cursor:pointer}
.task-content{flex:1}
.task-title{font-weight:600;margin-bottom:2px}
.task-due{font-size:12px;color:var(--muted)}
.task-countdown{font-size:12px;color:#ff6b6b;font-weight:600}
.results-table{width:100%;border-collapse:collapse;margin-top:10px;margin-bottom:20px}
.results-table th,
.results-table td{padding:8px;text-align:center;border:1px solid var(--cell-border)}
.results-table th{background:var(--panel);font-weight:bold}
.results-table tr:nth-child(even){background:var(--glass)}
.results-table input[type=number],
.results-table input[type=text]{
  width:100%;
  padding:4px;
  background:#0a0a0a;
  border:1px solid var(--cell-border);
  color:#e6edf3;
  border-radius:4px;
}
.results-table input[type=checkbox]{
  width:16px;
  height:16px;
  cursor:pointer;
}
.results-table td.disabled-cell {
  background: #1a1a1a !important;
  opacity: 0.4;
}
.results-table td.disabled-cell input {
  background: #1a1a1a !important;
  color: #555;
  pointer-events: none;
}
.completed .task-title{text-decoration:line-through;}
.failed .task-title{text-decoration:line-through;}
.task-item.completed {
box-shadow: 0 0 8px rgba(46, 204, 113, 0.4);
}
.task-item.failed {
box-shadow: 0 0 8px rgba(231, 76, 60, 0.4);
}
footer{margin-top:12px;color:var(--muted);font-size:13px}
@media (max-width:1100px){
  .app{padding:10px}
  .side{display:none}
}

/* Study Timer */
.study-timer-display {
font-size: 48px;
text-align: center;
margin: 20px 0;
font-weight: bold;
color: var(--accent);
}
.study-timer-controls {
display: flex;
justify-content: center;
gap: 10px;
margin: 10px 0;
}
.timer-settings {
margin: 15px 0;
display: flex;
justify-content: center;
gap: 10px;
align-items: center;
}
</style>
</head>
<body>
<div class="app" id="main-app">
<header>
<h1>Bac Master by Slinder</h1>
<p>Dark • Tabs • Autosave</p>
</header>
<div class="tab-nav">
<div class="tab active" data-tab="planner">Planner</div>
<div class="tab" data-tab="todo">Todo List</div>
<div class="tab" data-tab="results">Calculate Results</div>
<div class="tab" data-tab="study-timer">Study Timer</div>
</div>

<!-- PLANNER VIEW -->
<div id="planner-view" class="active">
  <div class="controls">
    <button id="addBtn" class="btn">+ Add Subject</button>
    
    <!-- Slot Duration Controls -->
    <div style="display:flex;gap:4px">
      <button class="btn ghost slot-btn" data-minutes="15">15m</button>
      <button class="btn ghost slot-btn" data-minutes="30">30m</button>
      <button class="btn ghost slot-btn" data-minutes="60">1h</button>
    </div>
    <span id="slotDisplay" style="color:var(--muted);font-size:13px">15 min</span>
    
    <!-- Zoom Controls -->
    <button id="zoomOut" class="btn ghost">–</button>
    <button id="zoomIn" class="btn ghost">+</button>
    <span id="zoomLevel" style="color:var(--muted);font-size:13px">100%</span>
    
    <button id="clearBtn" class="btn ghost">Clear All</button>
    <button id="exportBtn" class="btn ghost">Export JSON</button>
    <input id="importFile" type="file" accept="application/json" style="display:none" />
    <button id="importBtn" class="btn ghost">Import JSON</button>
    <div style="margin-left:auto;color:var(--muted)">Saved: <span id="savedAt">—</span></div>
  </div>
  <div class="layout">
    <div class="planner panel">
      <div class="grid-container">
        <div class="grid" id="grid"></div>
      </div>
    </div>
    <aside class="side">
      <div class="panel">
        <strong>Add / Edit Subject</strong>
        <p style="margin:6px 0 12px;color:var(--muted);font-size:13px">Title, 24h start/end, choose days, pick color or a palette style.</p>
        <form id="eventForm">
          <input type="hidden" id="eventId" />
          <label>Title</label>
          <input type="text" id="title" placeholder="e.g. Math" required />
          <div class="row" style="margin-top:8px">
            <div class="small">
              <label>Start (24h)</label>
              <input type="time" id="start" value="08:00" required />
            </div>
            <div class="small">
              <label>End (24h)</label>
              <input type="time" id="end" value="09:00" required />
            </div>
          </div>
          <label style="margin-top:8px">Days</label>
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">
            <label><input type="checkbox" value="0" class="daycb"> Mon</label>
            <label><input type="checkbox" value="1" class="daycb"> Tue</label>
            <label><input type="checkbox" value="2" class="daycb"> Wed</label>
            <label><input type="checkbox" value="3" class="daycb"> Thu</label>
            <label><input type="checkbox" value="4" class="daycb"> Fri</label>
            <label><input type="checkbox" value="5" class="daycb"> Sat</label>
            <label><input type="checkbox" value="6" class="daycb"> Sun</label>
          </div>
          <label>Choose color or palette style</label>
          <div style="display:flex;align-items:center;gap:8px">
            <input type="color" id="color" value="#ffb86b" style="height:40px;width:56px;border-radius:8px;border:none;padding:0;margin-right:8px" />
            <div id="presetColors" style="display:flex;gap:8px;flex-wrap:wrap"></div>
          </div>
          <div style="display:flex;gap:8px;margin-top:12px">
            <button type="submit" class="btn">Save</button>
            <button type="button" id="resetForm" class="btn ghost">Reset</button>
          </div>
        </form>
      </div>
      <div class="panel">
        <strong>Palette (manage styles)</strong>
        <p style="margin:6px 0;color:var(--muted);font-size:13px">Create named styles so you can reuse colors and labels. Edit label or remove a style.</p>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="color" id="newPalColor" value="#ffb86b" style="height:36px;width:60px;border-radius:6px;border:none;">
          <input type="text" id="newPalLabel" placeholder="Style name" style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--cell-border);background:#0a0a0a;color:inherit">
          <button id="addPalBtn" class="btn">Add</button>
        </div>
        <div class="palette-list" id="paletteList"></div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="clearPalBtn" class="btn ghost">Clear Palette</button>
          <button id="applyPalBtn" class="btn ghost" style="margin-left:auto">Use selected style</button>
        </div>
      </div>
      <div class="panel">
        <strong>Instructions</strong>
        <ul style="color:var(--muted);font-size:13px;margin:8px 0 0;padding-left:18px">
          <li>Use <strong>15m/30m/1h</strong> to change time slot size.</li>
          <li>Use <strong>+</strong>/<strong>–</strong> to zoom grid in/out.</li>
          <li>Click any cell to prefill time & day.</li>
          <li>Data autosaves locally (localStorage).</li>
        </ul>
      </div>
    </aside>
  </div>
</div>

<!-- TODO VIEW -->
<div id="todo-view" style="display:none;">
<div class="controls">
<button id="importTodoBtn" class="btn ghost">Import from Planner</button>
<div style="margin-left:auto;color:var(--muted)">Tasks: <span id="taskCount">0</span></div>
</div>
<div class="layout">
<div class="planner panel" style="padding:12px">
<div class="panel">
<strong>Add Task</strong>
<form id="taskForm" style="display:flex;flex-direction:column;gap:8px">
<input type="text" id="taskTitle" placeholder="e.g. Finish math homework" required />
<div class="row">
<input type="date" id="taskDate" />
<input type="time" id="taskTime" />
</div>
<button type="submit" class="btn">Add Task</button>
</form>
</div>
<div class="panel">
<strong>Tasks</strong>
<div id="taskList"></div>
</div>
</div>
<aside class="side">
<div class="panel">
<strong>Instructions</strong>
<ul style="color:var(--muted);font-size:13px;margin:8px 0 0;padding-left:18px">
<li>Tasks grouped by calendar day.</li>
<li>Use date + time pickers for easy scheduling.</li>
<li>Check to complete, use Undo if wrong.</li>
</ul>
</div>
<div class="panel">
<button id="undoCompleteBtn" class="btn ghost" disabled>Undo Last Completion</button>
</div>
</aside>
</div>
</div>

<!-- RESULTS VIEW -->
<div id="results-view" style="display:none;">
<div class="layout">
<div class="planner panel" style="padding:12px">
<div class="panel">
<strong>Calculate Results</strong>
<div style="display:flex;gap:10px;margin:10px 0;">
<button id="editResultsBtn" class="btn">Edit Mode</button>
<button id="saveResultsBtn" class="btn ghost" style="display:none;">Save & View</button>
</div>
<div id="resultsContent"></div>
</div>
</div>
<aside class="side">
<div class="panel">
<strong>How It Works</strong>
<ul style="color:var(--muted);font-size:13px;margin:8px 0 0;padding-left:18px">
<li>Edit grades directly in the table.</li>
<li>Click checkbox above each cell to disable it.</li>
<li>Disabled cells turn gray and excluded from calculation.</li>
</ul>
</div>
</aside>
</div>
</div>

<!-- STUDY TIMER VIEW -->
<div id="study-timer-view" style="display:none;">
<div class="layout">
<div class="planner panel" style="padding:12px; text-align:center;">
<div class="study-timer-display" id="study-timer-time">25:00</div>
<div class="timer-settings">
<label>Minutes:</label>
<input type="number" id="customMinutes" min="1" max="120" value="25" style="width:80px;text-align:center" />
</div>
<div class="study-timer-controls">
<button id="study-timer-start" class="btn">Start</button>
<button id="study-timer-pause" class="btn ghost" disabled>Pause</button>
<button id="study-timer-reset" class="btn ghost">Reset</button>
</div>
<div style="margin-top:10px; color:var(--muted);">
Customizable study timer
</div>
</div>
</div>
</div>

<footer>Bac Master by Slinder — All data stays on your device</footer>
</div>

<!-- Modals -->
<div id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center">
  <div style="background:var(--panel);padding:12px;border-radius:10px;width:420px;border:1px solid var(--cell-border)">
    <strong>Edit Subject</strong>
    <form id="editForm" style="margin-top:8px">
      <input type="hidden" id="editId">
      <label>Title</label>
      <input type="text" id="editTitle" style="width:100%">
      <div style="display:flex;gap:8px;margin-top:6px">
        <input type="time" id="editStart" style="flex:1">
        <input type="time" id="editEnd" style="flex:1">
      </div>
      <label style="margin-top:8px">Color</label>
      <input type="color" id="editColor">
      <div style="display:flex;gap:8px;margin-top:10px">
        <button type="submit" class="btn">Update</button>
        <button type="button" id="deleteBtn" class="btn ghost">Delete</button>
        <button type="button" id="closeModal" class="btn ghost">Close</button>
      </div>
    </form>
  </div>
</div>
<div id="taskModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center">
<div style="background:var(--panel);padding:12px;border-radius:10px;width:420px;border:1px solid var(--cell-border)">
<strong>Edit Task</strong>
<form id="editTaskForm" style="margin-top:8px">
<input type="hidden" id="editTaskId">
<label>Title</label>
<input type="text" id="editTaskTitle" style="width:100%" required />
<div class="row" style="margin-top:6px">
<input type="date" id="editTaskDate" style="flex:1" required />
<input type="time" id="editTaskTime" style="flex:1" required />
</div>
<div style="display:flex;gap:8px;margin-top:12px">
<button type="submit" class="btn">Update</button>
<button type="button" id="deleteTaskBtn" class="btn ghost">Delete</button>
<button type="button" id="closeTaskModal" class="btn ghost">Close</button>
</div>
</form>
</div>
</div>

<script>
// ======================
// CONFIG
// ======================
const DAYS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
const EVENTS_KEY = 'planner_events_v5';
const TASKS_KEY = 'planner_tasks_v9';
const RESULTS_KEY = 'results_data_v4';
const PALETTE_KEY = 'planner_palette_v5';
const ZOOM_KEY = 'planner_zoom_v2';
const SLOT_KEY = 'planner_slot_v1';

let events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
let tasks = JSON.parse(localStorage.getItem(TASKS_KEY) || '[]');

// Force new default data structure
let resultsData = JSON.parse(localStorage.getItem(RESULTS_KEY) || 'null');
if (!resultsData || !resultsData.trimester2 || resultsData.trimester2.length === 0) {
  resultsData = getDefaultEmptyResults();
  localStorage.setItem(RESULTS_KEY, JSON.stringify(resultsData));
}

let palette = JSON.parse(localStorage.getItem(PALETTE_KEY) || '[]');
let selectedPaletteId = null;
let zoomLevel = parseFloat(localStorage.getItem(ZOOM_KEY) || '1.0');
let MINUTES_PER_SLOT = parseInt(localStorage.getItem(SLOT_KEY) || '15');
let lastCompletedTask = null;
let isEditingResults = false;

function getDefaultEmptyResults() {
return {
trimester1: [
{subject: "Maths", coeff: 3, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "Physique", coeff: 3, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "algo", coeff: 3, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "sti", coeff: 3, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "Philosophie", coeff: 1, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "espagnol", coeff: 1, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "Arabe", coeff: 1, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "Français", coeff: 1, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "Anglais", coeff: 1, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "Sport", coeff: 1, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}}
],
trimester2: [
{subject: "Maths", coeff: 3, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "Physique", coeff: 3, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "algo", coeff: 3, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "sti", coeff: 3, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "Philosophie", coeff: 1, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "espagnol", coeff: 1, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "Arabe", coeff: 1, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "Français", coeff: 1, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "Anglais", coeff: 1, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "Sport", coeff: 1, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}}
],
trimester3: [
{subject: "Maths", coeff: 3, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "Physique", coeff: 3, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "algo", coeff: 3, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "sti", coeff: 3, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "Philosophie", coeff: 1, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "espagnol", coeff: 1, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "Arabe", coeff: 1, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "Français", coeff: 1, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "Anglais", coeff: 1, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}},
{subject: "Sport", coeff: 1, oral: "", ctrl: "", synth: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false}}
],
bac: [
{subject: "Maths", coeff: 3, note: "", total: ""},
{subject: "Physique", coeff: 2, note: "", total: ""},
{subject: "algo", coeff: 3, note: "", total: ""},
{subject: "sti", coeff: 3, note: "", total: ""},
{subject: "Arabe", coeff: 1, note: "", total: ""},
{subject: "espagnol", coeff: 1, note: "", total: ""},
{subject: "Anglais", coeff: 1, note: "", total: ""},
{subject: "Philo", coeff: 1, note: "", total: ""},
{subject: "Français", coeff: 1, note: "", total: ""},
{subject: "Sport", coeff: 1, note: "", total: ""}
]
};
}

// ======================
// UTILS
// ======================
function calculateAverage(oral, ctrl, synth, disabledCells) {
// Check which cells are disabled
const oralDisabled = disabledCells && disabledCells.oral;
const ctrlDisabled = disabledCells && disabledCells.ctrl;
const synthDisabled = disabledCells && disabledCells.synth;

// Convert empty strings to null for easier checking, but only for enabled cells
const oralVal = (oralDisabled || oral === "" || oral === null) ? null : parseFloat(oral);
const ctrlVal = (ctrlDisabled || ctrl === "" || ctrl === null) ? null : parseFloat(ctrl);
const synthVal = (synthDisabled || synth === "" || synth === null) ? null : parseFloat(synth);

// Count how many values we have
const hasOral = oralVal !== null;
const hasCtrl = ctrlVal !== null;
const hasSynth = synthVal !== null;

// If only synthese note, avg is the same note
if (!hasOral && !hasCtrl && hasSynth) {
  return synthVal.toFixed(2);
}

// If controle + synthese, avg is: (controle*1 + synthese*2)/3
if (!hasOral && hasCtrl && hasSynth) {
  return ((ctrlVal * 1 + synthVal * 2) / 3).toFixed(2);
}

// If oral + controle + synthese, avg is: (oral*1 + controle*1 + synthese*2)/4
if (hasOral && hasCtrl && hasSynth) {
  return ((oralVal * 1 + ctrlVal * 1 + synthVal * 2) / 4).toFixed(2);
}

// If only oral + controle, avg is: (oral*1 + controle*1)/2
if (hasOral && hasCtrl && !hasSynth) {
  return ((oralVal * 1 + ctrlVal * 1) / 2).toFixed(2);
}

// If only oral
if (hasOral && !hasCtrl && !hasSynth) {
  return oralVal.toFixed(2);
}

// If only controle
if (!hasOral && hasCtrl && !hasSynth) {
  return ctrlVal.toFixed(2);
}

// No values provided
return "";
}

function calculateTotal(avg, coeff) {
if (avg === "" || coeff === 0 || avg === null || coeff === null) return "";
return (parseFloat(avg) * parseFloat(coeff)).toFixed(2);
}
function saveResults() {
localStorage.setItem(RESULTS_KEY, JSON.stringify(resultsData));
}
function calmChime(duration = 800, frequency = 600) {
const ctx = new (window.AudioContext || window.webkitAudioContext)();
const osc = ctx.createOscillator();
const gain = ctx.createGain();
osc.connect(gain);
gain.connect(ctx.destination);
osc.frequency.value = frequency;
osc.type = 'sine';
gain.gain.setValueAtTime(0.2, ctx.currentTime);
gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration / 1000);
osc.start();
osc.stop(ctx.currentTime + duration / 1000);
}

// ======================
// RESULTS RENDERING
// ======================
function renderResults() {
const content = document.getElementById('resultsContent');
function renderSimpleTable(title, data, fields) {
let html = `<h3>${title}</h3><table class="results-table">`;
html += `<tr>${fields.map(f => `<th>${f.label}</th>`).join('')}</tr>`;
data.forEach(row => {
html += `<tr>`;
fields.forEach(f => {
const isDisabled = row.disabledCells && row.disabledCells[f.key];
const cellClass = isDisabled ? ' class="disabled-cell"' : '';
html += `<td${cellClass}>${row[f.key] !== undefined && row[f.key] !== null ? row[f.key] : ''}</td>`;
});
html += `</tr>`;
});
html += `</table>`;
return html;
}
function calculateFinalAverage(data) {
let totalScore = 0, totalCoeff = 0;
data.forEach(row => {
if (row.total && row.coeff && row.total !== "") {
totalScore += parseFloat(row.total);
totalCoeff += parseFloat(row.coeff);
}
});
if (totalCoeff > 0) {
return (totalScore / totalCoeff).toFixed(2);
} else {
return "0.00";
}
}
let html = '';
html += renderSimpleTable("1st Trimester", resultsData.trimester1, [
{label: "Subject", key: "subject"},
{label: "Coeff", key: "coeff"},
{label: "Oral", key: "oral"},
{label: "Ctrl", key: "ctrl"},
{label: "Synth", key: "synth"},
{label: "Avg", key: "avg"},
{label: "Total", key: "total"}
]);
html += `<div style="margin-top:8px;padding:8px;background:var(--glass);border-radius:6px;"><strong>Final Average:</strong> ${calculateFinalAverage(resultsData.trimester1)} / 20</div>`;
html += renderSimpleTable("2nd Trimester", resultsData.trimester2, [
{label: "Subject", key: "subject"},
{label: "Coeff", key: "coeff"},
{label: "Oral", key: "oral"},
{label: "Ctrl", key: "ctrl"},
{label: "Synth", key: "synth"},
{label: "Avg", key: "avg"},
{label: "Total", key: "total"}
]);
html += `<div style="margin-top:8px;padding:8px;background:var(--glass);border-radius:6px;"><strong>Final Average:</strong> ${calculateFinalAverage(resultsData.trimester2)} / 20</div>`;
html += renderSimpleTable("3rd Trimester", resultsData.trimester3, [
{label: "Subject", key: "subject"},
{label: "Coeff", key: "coeff"},
{label: "Oral", key: "oral"},
{label: "Ctrl", key: "ctrl"},
{label: "Synth", key: "synth"},
{label: "Avg", key: "avg"},
{label: "Total", key: "total"}
]);
html += `<div style="margin-top:8px;padding:8px;background:var(--glass);border-radius:6px;"><strong>Final Average:</strong> ${calculateFinalAverage(resultsData.trimester3)} / 20</div>`;
html += renderSimpleTable("BAC", resultsData.bac, [
{label: "Subject", key: "subject"},
{label: "Coeff", key: "coeff"},
{label: "Note", key: "note"},
{label: "Total", key: "total"}
]);
html += `<div style="margin-top:8px;padding:8px;background:var(--glass);border-radius:6px;"><strong>Final Average:</strong> ${calculateFinalAverage(resultsData.bac)} / 20</div>`;
content.innerHTML = html;
}

function renderResultsEditable() {
const content = document.getElementById('resultsContent');
let html = '';

function renderEditableTable(trimesterKey, title, fields) {
const data = resultsData[trimesterKey];
html += `<h3>${title}</h3><table class="results-table">`;
html += `<tr>${fields.map(f => `<th>${f.label}</th>`).join('')}<th>Action</th></tr>`;

// Add checkboxes row for disabling cells (only for editable fields)
if (trimesterKey !== 'bac') {
html += `<tr style="background:#0a0a0a"><td colspan="2"></td>`;
['oral', 'ctrl', 'synth'].forEach(field => {
html += `<td><input type="checkbox" checked class="cell-toggle-header" data-field="${field}" title="Toggle all ${field}" /></td>`;
});
html += `<td colspan="3"></td></tr>`;
}

data.forEach((row, i) => {
if (!row.disabledCells) {
row.disabledCells = {oral: false, ctrl: false, synth: false};
}
html += `<tr>`;
fields.forEach(f => {
const val = row[f.key] ?? "";
const isDisabled = row.disabledCells && row.disabledCells[f.key];
const cellClass = isDisabled ? ' class="disabled-cell"' : '';
if (f.editable === false) {
html += `<td${cellClass}>${val}</td>`;
} else if (f.key === 'oral' || f.key === 'ctrl' || f.key === 'synth') {
// Add checkbox above the input for these fields
html += `<td${cellClass}>`;
html += `<div style="display:flex;flex-direction:column;align-items:center;gap:2px;">`;
html += `<input type="checkbox" ${!isDisabled ? 'checked' : ''} class="cell-toggle" data-trimester="${trimesterKey}" data-index="${i}" data-field="${f.key}" />`;
html += `<input type="${f.type || 'text'}" step="${f.step || 'any'}" value="${val}" data-trimester="${trimesterKey}" data-index="${i}" data-field="${f.key}" ${isDisabled ? 'disabled' : ''} />`;
html += `</div></td>`;
} else {
html += `<td${cellClass}><input type="${f.type || 'text'}" step="${f.step || 'any'}" value="${val}" data-trimester="${trimesterKey}" data-index="${i}" data-field="${f.key}" /></td>`;
}
});
html += `<td><button class="btn ghost del-row" data-trimester="${trimesterKey}" data-index="${i}">Del</button></td></tr>`;
});
html += `<tr><td colspan="${fields.length + 1}"><button class="btn ghost add-row" data-trimester="${trimesterKey}">+ Add Row</button></td></tr>`;
html += `</table>`;
}

renderEditableTable('trimester1', '1st Trimester', [
{label: "Subject", key: "subject", type: "text"},
{label: "Coeff", key: "coeff", type: "number", step: "1"},
{label: "Oral", key: "oral", type: "number", step: "0.01"},
{label: "Ctrl", key: "ctrl", type: "number", step: "0.01"},
{label: "Synth", key: "synth", type: "number", step: "0.01"},
{label: "Avg", key: "avg", editable: false},
{label: "Total", key: "total", editable: false}
]);

renderEditableTable('trimester2', '2nd Trimester', [
{label: "Subject", key: "subject", type: "text"},
{label: "Coeff", key: "coeff", type: "number", step: "1"},
{label: "Oral", key: "oral", type: "number", step: "0.01"},
{label: "Ctrl", key: "ctrl", type: "number", step: "0.01"},
{label: "Synth", key: "synth", type: "number", step: "0.01"},
{label: "Avg", key: "avg", editable: false},
{label: "Total", key: "total", editable: false}
]);

renderEditableTable('trimester3', '3rd Trimester', [
{label: "Subject", key: "subject", type: "text"},
{label: "Coeff", key: "coeff", type: "number", step: "1"},
{label: "Oral", key: "oral", type: "number", step: "0.01"},
{label: "Ctrl", key: "ctrl", type: "number", step: "0.01"},
{label: "Synth", key: "synth", type: "number", step: "0.01"},
{label: "Avg", key: "avg", editable: false},
{label: "Total", key: "total", editable: false}
]);

renderEditableTable('bac', 'BAC', [
{label: "Subject", key: "subject", type: "text"},
{label: "Coeff", key: "coeff", type: "number", step: "1"},
{label: "Note", key: "note", type: "number", step: "0.01"},
{label: "Total", key: "total", editable: false}
]);

content.innerHTML = html;

// Handle cell toggle (enable/disable individual cells)
document.querySelectorAll('.cell-toggle').forEach(checkbox => {
checkbox.addEventListener('change', (e) => {
const trimester = e.target.dataset.trimester;
const index = parseInt(e.target.dataset.index);
const field = e.target.dataset.field;
const isEnabled = e.target.checked;
if (!resultsData[trimester][index].disabledCells) {
resultsData[trimester][index].disabledCells = {oral: false, ctrl: false, synth: false};
}
resultsData[trimester][index].disabledCells[field] = !isEnabled;
const input = e.target.parentElement.querySelector('input[type="number"]');
const cell = e.target.closest('td');
if (isEnabled) {
input.disabled = false;
cell.classList.remove('disabled-cell');
} else {
input.disabled = true;
cell.classList.add('disabled-cell');
}
// Recalculate average
const row = resultsData[trimester][index];
row.avg = calculateAverage(row.oral, row.ctrl, row.synth, row.disabledCells);
row.total = calculateTotal(row.avg, row.coeff);
const avgCell = e.target.closest('tr').querySelector(`td:nth-child(7)`);
const totalCell = e.target.closest('tr').querySelector(`td:nth-child(8)`);
if (avgCell) avgCell.textContent = row.avg;
if (totalCell) totalCell.textContent = row.total;
});
});

document.querySelectorAll('#resultsContent input[data-field]').forEach(input => {
if (input.type === 'checkbox') return; // Skip checkboxes
input.addEventListener('input', (e) => {
const trimester = e.target.dataset.trimester;
const index = parseInt(e.target.dataset.index);
const field = e.target.dataset.field;
const value = e.target.value === "" ? "" : (field === 'subject' ? e.target.value : parseFloat(e.target.value));

resultsData[trimester][index][field] = value;

if (trimester !== 'bac') {
if (field !== 'subject' && field !== 'coeff') {
const row = resultsData[trimester][index];
row.avg = calculateAverage(row.oral, row.ctrl, row.synth, row.disabledCells);
row.total = calculateTotal(row.avg, row.coeff);
// Re-render to show updated avg and total
const avgCell = e.target.closest('tr').querySelector(`td:nth-child(7)`);
const totalCell = e.target.closest('tr').querySelector(`td:nth-child(8)`);
if (avgCell) avgCell.textContent = row.avg;
if (totalCell) totalCell.textContent = row.total;
}
} else {
if (field === 'note' || field === 'coeff') {
const row = resultsData.bac[index];
row.total = calculateTotal(row.note, row.coeff);
// Re-render to show updated total
const totalCell = e.target.closest('tr').querySelector(`td:nth-child(5)`);
if (totalCell) totalCell.textContent = row.total;
}
}
});
});

document.querySelectorAll('.add-row').forEach(btn => {
btn.addEventListener('click', (e) => {
const trimester = e.target.dataset.trimester;
const newRow = { subject: "New", coeff: 1, oral: "", ctrl: "", synth: "", note: "", avg: "", total: "", disabledCells: {oral: false, ctrl: false, synth: false} };
resultsData[trimester].push(newRow);
renderResultsEditable();
});
});

document.querySelectorAll('.del-row').forEach(btn => {
btn.addEventListener('click', (e) => {
const trimester = e.target.dataset.trimester;
const index = parseInt(e.target.dataset.index);
resultsData[trimester].splice(index, 1);
renderResultsEditable();
});
});
}

document.getElementById('editResultsBtn').addEventListener('click', () => {
isEditingResults = true;
document.getElementById('editResultsBtn').style.display = 'none';
document.getElementById('saveResultsBtn').style.display = 'inline-block';
renderResultsEditable();
});

document.getElementById('saveResultsBtn').addEventListener('click', () => {
isEditingResults = false;
saveResults();
document.getElementById('editResultsBtn').style.display = 'inline-block';
document.getElementById('saveResultsBtn').style.display = 'none';
renderResults();
});

// ======================
// PLANNER — EXACTLY FROM YOUR FILE
// ======================
function buildGrid() {
const grid = document.getElementById('grid');
grid.innerHTML = '';
const SLOTS_PER_HOUR = 60 / MINUTES_PER_SLOT;
const TOTAL_SLOTS = 24 * SLOTS_PER_HOUR;
const baseSlotWidth = 60;
const slotWidth = baseSlotWidth * (15 / MINUTES_PER_SLOT);
grid.style.gridTemplateColumns = `140px repeat(${TOTAL_SLOTS}, ${slotWidth}px)`;
grid.style.gridAutoRows = '56px';
grid.appendChild(createCell('header-cell', ''));
for (let slot = 0; slot < TOTAL_SLOTS; slot++) {
const text = (slot % SLOTS_PER_HOUR === 0) ? String(slot / SLOTS_PER_HOUR).padStart(2, '0') + ':00' : '';
grid.appendChild(createCell('header-cell', text));
}
for (let d = 0; d < 7; d++) {
grid.appendChild(createCell('day-name', DAYS[d]));
for (let slot = 0; slot < TOTAL_SLOTS; slot++) {
const cell = createCell('cell', '');
cell.dataset.day = d;
cell.dataset.slot = slot;
grid.appendChild(cell);
}
}
}
function createCell(className, text) {
const el = document.createElement('div');
el.className = 'cell ' + className;
el.textContent = text;
return el;
}
function timeToSlot(timeStr) {
const [h, m] = timeStr.split(':').map(Number);
const SLOTS_PER_HOUR = 60 / MINUTES_PER_SLOT;
return h * SLOTS_PER_HOUR + Math.floor(m / MINUTES_PER_SLOT);
}
function slotToTime(slot) {
const SLOTS_PER_HOUR = 60 / MINUTES_PER_SLOT;
const totalMinutes = slot * MINUTES_PER_SLOT;
const h = Math.floor(totalMinutes / 60) % 24;
const m = totalMinutes % 60;
return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}
function timeToMinutes(t) {
const [h, m] = t.split(':').map(Number);
return h * 60 + m;
}
function renderPlanner() {
document.querySelectorAll('.event').forEach(e => e.remove());
const grid = document.getElementById('grid');
const leftCol = 140;
const SLOTS_PER_HOUR = 60 / MINUTES_PER_SLOT;
const baseSlotWidth = 60;
const slotWidth = baseSlotWidth * (15 / MINUTES_PER_SLOT);
events.forEach(ev => {
const startSlot = timeToSlot(ev.start);
const endSlot = timeToSlot(ev.end);
const duration = endSlot - startSlot;
(ev.days || []).forEach(day => {
const rowOffset = 56;
const x = leftCol + startSlot * slotWidth;
const y = (day + 1) * rowOffset;
const w = duration * slotWidth;
const eventEl = document.createElement('div');
eventEl.className = 'event';
eventEl.style.left = x + 'px';
eventEl.style.top = y + 'px';
eventEl.style.width = w + 'px';
eventEl.style.background = ev.color || '#ffb86b';
eventEl.innerHTML = `${ev.title}<small>${ev.start} – ${ev.end}</small>`;
eventEl.dataset.id = ev.id;
grid.appendChild(eventEl);
});
});
}
function savePlanner() {
localStorage.setItem(EVENTS_KEY, JSON.stringify(events));
document.getElementById('savedAt').textContent = new Date().toLocaleTimeString();
}

const form = document.getElementById('eventForm');
form.addEventListener('submit', e => {
e.preventDefault();
const id = document.getElementById('eventId').value;
const title = document.getElementById('title').value.trim();
const start = document.getElementById('start').value;
const end = document.getElementById('end').value;
const color = document.getElementById('color').value;
const days = Array.from(document.querySelectorAll('.daycb:checked')).map(cb => parseInt(cb.value));
const eventData = { title, start, end, color, days };
if (id) {
const ev = events.find(e => e.id == id);
if (ev) Object.assign(ev, eventData);
} else {
eventData.id = Date.now();
events.push(eventData);
}
savePlanner();
renderPlanner();
form.reset();
document.getElementById('eventId').value = '';
document.querySelectorAll('.daycb').forEach(cb => cb.checked = false);
});

document.getElementById('resetForm').addEventListener('click', () => {
form.reset();
document.getElementById('eventId').value = '';
document.querySelectorAll('.daycb').forEach(cb => cb.checked = false);
});

document.getElementById('addBtn').addEventListener('click', () => {
document.getElementById('title').focus();
});

document.getElementById('clearBtn').addEventListener('click', () => {
if (confirm('Clear all?')) {
events = [];
savePlanner();
renderPlanner();
}
});

document.getElementById('exportBtn').addEventListener('click', () => {
const blob = new Blob([JSON.stringify({ events, palette }, null, 2)], { type: 'application/json' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = 'planner_export.json';
a.click();
});

document.getElementById('importBtn').addEventListener('click', () => {
document.getElementById('importFile').click();
});

document.getElementById('importFile').addEventListener('change', e => {
const file = e.target.files[0];
if (!file) return;
const reader = new FileReader();
reader.onload = ev => {
try {
const data = JSON.parse(ev.target.result);
if (data.events) events = data.events;
if (data.palette) palette = data.palette;
savePlanner();
renderPlanner();
renderPalette();
alert('Imported!');
} catch (err) {
alert('Failed to import');
}
};
reader.readAsText(file);
e.target.value = '';
});

document.getElementById('grid').addEventListener('click', e => {
if (e.target.classList.contains('cell') && !e.target.classList.contains('day-name') && !e.target.classList.contains('header-cell')) {
const day = parseInt(e.target.dataset.day);
const slot = parseInt(e.target.dataset.slot);
document.getElementById('start').value = slotToTime(slot);
document.getElementById('end').value = slotToTime(slot + 1);
const daycb = document.querySelector(`.daycb[value="${day}"]`);
if (daycb) daycb.checked = true;
}
if (e.target.classList.contains('event') || e.target.closest('.event')) {
const eventEl = e.target.closest('.event') || e.target;
const id = eventEl.dataset.id;
const ev = events.find(e => e.id == id);
if (ev) {
document.getElementById('editId').value = ev.id;
document.getElementById('editTitle').value = ev.title;
document.getElementById('editStart').value = ev.start;
document.getElementById('editEnd').value = ev.end;
document.getElementById('editColor').value = ev.color;
document.getElementById('modal').style.display = 'flex';
}
}
});

document.getElementById('closeModal').addEventListener('click', () => {
document.getElementById('modal').style.display = 'none';
});

document.getElementById('editForm').addEventListener('submit', e => {
e.preventDefault();
const id = document.getElementById('editId').value;
const ev = events.find(e => e.id == id);
if (ev) {
ev.title = document.getElementById('editTitle').value;
ev.start = document.getElementById('editStart').value;
ev.end = document.getElementById('editEnd').value;
ev.color = document.getElementById('editColor').value;
savePlanner();
renderPlanner();
document.getElementById('modal').style.display = 'none';
}
});

document.getElementById('deleteBtn').addEventListener('click', () => {
const id = document.getElementById('editId').value;
events = events.filter(e => e.id != id);
savePlanner();
renderPlanner();
document.getElementById('modal').style.display = 'none';
});

// ZOOM CONTROLS
document.getElementById('zoomOut').addEventListener('click', () => {
zoomLevel = Math.max(0.5, zoomLevel - 0.1);
localStorage.setItem(ZOOM_KEY, zoomLevel);
applyZoom();
});
document.getElementById('zoomIn').addEventListener('click', () => {
zoomLevel = Math.min(2, zoomLevel + 0.1);
localStorage.setItem(ZOOM_KEY, zoomLevel);
applyZoom();
});
function applyZoom() {
const grid = document.getElementById('grid');
grid.style.transform = `scale(${zoomLevel})`;
document.getElementById('zoomLevel').textContent = `${Math.round(zoomLevel * 100)}%`;
}

// SLOT DURATION CONTROLS
document.querySelectorAll('.slot-btn').forEach(btn => {
btn.addEventListener('click', () => {
document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('active'));
btn.classList.add('active');
MINUTES_PER_SLOT = parseInt(btn.dataset.minutes);
localStorage.setItem(SLOT_KEY, MINUTES_PER_SLOT);
const units = MINUTES_PER_SLOT >= 60 ? `${MINUTES_PER_SLOT / 60}h` : `${MINUTES_PER_SLOT}m`;
document.getElementById('slotDisplay').textContent = units;
buildGrid();
renderPlanner();
});
});
const activeSlotBtn = document.querySelector(`.slot-btn[data-minutes="${MINUTES_PER_SLOT}"]`);
if (activeSlotBtn) activeSlotBtn.classList.add('active');
const slotUnits = MINUTES_PER_SLOT >= 60 ? `${MINUTES_PER_SLOT / 60}h` : `${MINUTES_PER_SLOT}m`;
document.getElementById('slotDisplay').textContent = slotUnits;

// ======================
// PALETTE MANAGEMENT
// ======================
function renderPalette() {
const list = document.getElementById('paletteList');
list.innerHTML = '';
palette.forEach(p => {
const row = document.createElement('div');
row.className = 'pal-row';
row.dataset.id = p.id;
row.innerHTML = `
<div class="swatch" style="background:${p.color}"></div>
<input class="pal-label" type="text" value="${p.label}" data-id="${p.id}" />
<button class="btn ghost" style="margin-left:auto;padding:4px 8px;font-size:11px">Remove</button>
`;
list.appendChild(row);
});
}

document.getElementById('addPalBtn').addEventListener('click', () => {
const color = document.getElementById('newPalColor').value;
const label = document.getElementById('newPalLabel').value.trim() || 'Unnamed';
palette.push({ id: Date.now(), color, label });
localStorage.setItem(PALETTE_KEY, JSON.stringify(palette));
renderPalette();
document.getElementById('newPalLabel').value = '';
});

document.getElementById('clearPalBtn').addEventListener('click', () => {
if (confirm('Clear palette?')) {
palette = [];
localStorage.setItem(PALETTE_KEY, JSON.stringify(palette));
renderPalette();
}
});

document.getElementById('paletteList').addEventListener('click', e => {
if (e.target.classList.contains('btn')) {
const row = e.target.closest('.pal-row');
const id = parseInt(row.dataset.id);
palette = palette.filter(p => p.id !== id);
localStorage.setItem(PALETTE_KEY, JSON.stringify(palette));
renderPalette();
}
if (e.target.classList.contains('swatch')) {
const row = e.target.closest('.pal-row');
const id = parseInt(row.dataset.id);
selectedPaletteId = id;
document.querySelectorAll('.pal-row').forEach(r => r.style.outline = 'none');
row.style.outline = '2px solid var(--accent)';
}
});

document.getElementById('paletteList').addEventListener('input', e => {
if (e.target.classList.contains('pal-label')) {
const id = parseInt(e.target.dataset.id);
const p = palette.find(p => p.id === id);
if (p) p.label = e.target.value;
localStorage.setItem(PALETTE_KEY, JSON.stringify(palette));
}
});

document.getElementById('applyPalBtn').addEventListener('click', () => {
if (!selectedPaletteId) return;
const p = palette.find(p => p.id === selectedPaletteId);
if (!p) return;
document.getElementById('color').value = p.color;
document.getElementById('title').value = p.label;
});

const PRESET_COLORS = ['#ffb86b', '#ff6b9d', '#c084fc', '#60a5fa', '#34d399', '#fbbf24', '#f87171'];
const presetDiv = document.getElementById('presetColors');
PRESET_COLORS.forEach(c => {
const s = document.createElement('div');
s.className = 'swatch';
s.style.background = c;
s.addEventListener('click', () => {
document.getElementById('color').value = c;
});
presetDiv.appendChild(s);
});

// ======================
// TODO LIST
// ======================
function saveTasks() {
localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
}
function formatCountdown(ms) {
if (ms <= 0) return "Expired";
const totalSeconds = Math.floor(ms / 1000);
const days = Math.floor(totalSeconds / 86400);
const hrs = Math.floor((totalSeconds % 86400) / 3600);
const mins = Math.floor((totalSeconds % 3600) / 60);
const secs = totalSeconds % 60;
if (days > 0) return `${days}d ${hrs}h ${mins}m`;
if (hrs > 0) return `${hrs}h ${mins}m ${secs}s`;
return `${mins}m ${secs}s`;
}
function renderTodo() {
const list = document.getElementById('taskList');
list.innerHTML = '';
const grouped = {};
tasks.forEach(task => {
const due = new Date(task.due);
const dayKey = due.toDateString();
if (!grouped[dayKey]) grouped[dayKey] = [];
grouped[dayKey].push(task);
});
Object.keys(grouped).sort().forEach(dayKey => {
const header = document.createElement('div');
header.style.fontWeight = 'bold';
header.style.marginTop = '10px';
header.textContent = dayKey;
list.appendChild(header);
grouped[dayKey].forEach(task => {
const due = new Date(task.due);
const now = Date.now();
const diffMs = task.due - now;
const item = document.createElement('div');
item.className = 'task-item';
if (task.completed) item.classList.add('completed');
if (task.failed) item.classList.add('failed');
item.innerHTML = `
<input type="checkbox" class="task-checkbox" ${task.completed ? 'checked disabled' : task.failed ? 'disabled' : ''} data-id="${task.id}">
<div class="task-content">
<div class="task-title">${task.title}</div>
<div class="task-due">${due.toLocaleString()}</div>
<div class="task-countdown">${formatCountdown(diffMs)}</div>
</div>
<div class="task-status" style="color:${task.completed ? '#27ae60' : task.failed ? '#e74c3c' : 'inherit'}">
${task.completed ? 'Completed' : task.failed ? 'Thrown' : ''}
</div>
<button class="btn ghost" style="padding:4px 8px;font-size:11px;" data-id="${task.id}">Edit</button>
${!task.completed && !task.failed ? `<button class="btn ghost skip-btn" style="padding:4px 8px;font-size:11px;" data-id="${task.id}">Skip</button>` : ''}
`;
list.appendChild(item);
});
});
document.getElementById('taskCount').textContent = tasks.length;
document.querySelectorAll('.task-checkbox').forEach(cb => {
cb.addEventListener('change', (e) => {
const id = e.target.dataset.id;
const task = tasks.find(t => t.id == id);
if (task && !task.completed && !task.failed) {
task.completed = true;
lastCompletedTask = {...task};
saveTasks();
renderTodo();
calmChime();
}
});
});
document.querySelectorAll('.skip-btn').forEach(btn => {
btn.addEventListener('click', (e) => {
const id = e.target.dataset.id;
const task = tasks.find(t => t.id == id);
if (task && !task.completed && !task.failed) {
task.failed = true;
saveTasks();
renderTodo();
}
});
});
document.querySelectorAll('[data-id]').forEach(btn => {
if (btn.classList.contains('btn') && !btn.classList.contains('skip-btn')) {
btn.addEventListener('click', (e) => {
const id = e.target.dataset.id;
const task = tasks.find(t => t.id == id);
if (task) {
document.getElementById('editTaskId').value = task.id;
document.getElementById('editTaskTitle').value = task.title;
const due = new Date(task.due);
document.getElementById('editTaskDate').value = due.toISOString().split('T')[0];
document.getElementById('editTaskTime').value = due.toTimeString().slice(0,5);
document.getElementById('taskModal').style.display = 'flex';
}
});
}
});
document.getElementById('undoCompleteBtn').disabled = !lastCompletedTask;
}
document.getElementById('taskForm').addEventListener('submit', e => {
e.preventDefault();
const title = document.getElementById('taskTitle').value.trim();
const dateStr = document.getElementById('taskDate').value;
const timeStr = document.getElementById('taskTime').value;
if (!title || !dateStr || !timeStr) return alert('Fill all fields');
const due = new Date(`${dateStr}T${timeStr}`);
tasks.push({
id: Date.now(),
title,
due: due.getTime(),
completed: false,
failed: false
});
saveTasks();
renderTodo();
document.getElementById('taskForm').reset();
const todayStr = new Date().toISOString().split('T')[0];
document.getElementById('taskDate').value = todayStr;
document.getElementById('taskTime').value = '09:00';
});
document.getElementById('undoCompleteBtn').addEventListener('click', () => {
if (lastCompletedTask) {
const task = tasks.find(t => t.id == lastCompletedTask.id);
if (task) {
task.completed = false;
task.failed = false;
}
saveTasks();
renderTodo();
lastCompletedTask = null;
}
});
document.getElementById('importTodoBtn').addEventListener('click', () => {
events.forEach(ev => {
(ev.days || []).forEach(dayIndex => {
const day = new Date();
day.setDate(day.getDate() + ((dayIndex - day.getDay() + 7) % 7));
const [sh, sm] = ev.start.split(':').map(Number);
day.setHours(sh, sm, 0, 0);
tasks.push({
id: Date.now(),
title: ev.title,
due: day.getTime(),
completed: false,
failed: false
});
});
});
saveTasks();
renderTodo();
alert('Imported!');
});
let countdownInterval = null;
function startCountdown() {
if (countdownInterval) clearInterval(countdownInterval);
countdownInterval = setInterval(() => {
const now = Date.now();
let updated = false;
tasks.forEach(task => {
if (!task.completed && !task.failed) {
const diff = task.due - now;
const countdownEl = document.querySelector(`.task-checkbox[data-id="${task.id}"]`)?.closest('.task-item')?.querySelector('.task-countdown');
if (countdownEl) {
countdownEl.textContent = formatCountdown(diff);
if (diff <= 0) {
task.failed = true;
updated = true;
}
}
}
});
if (updated) {
saveTasks();
renderTodo();
}
}, 1000);
}

// ======================
// STUDY TIMER
// ======================
let studyTimer = null;
let studySeconds = 25 * 60;
let studyRunning = false;

function updateStudyTimerDisplay() {
const mins = Math.floor(studySeconds / 60);
const secs = studySeconds % 60;
document.getElementById('study-timer-time').textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
}

function startStudyTimer() {
if (studyRunning) return;
const minsInput = parseInt(document.getElementById('customMinutes').value) || 25;
studySeconds = minsInput * 60;
updateStudyTimerDisplay();
studyRunning = true;
document.getElementById('study-timer-start').disabled = true;
document.getElementById('study-timer-pause').disabled = false;
studyTimer = setInterval(() => {
studySeconds--;
updateStudyTimerDisplay();
if (studySeconds <= 0) {
clearInterval(studyTimer);
calmChime();
studyRunning = false;
document.getElementById('study-timer-start').disabled = false;
document.getElementById('study-timer-pause').disabled = true;
}
}, 1000);
}

function pauseStudyTimer() {
if (!studyRunning) return;
clearInterval(studyTimer);
studyRunning = false;
document.getElementById('study-timer-start').disabled = false;
document.getElementById('study-timer-pause').disabled = true;
}

function resetStudyTimer() {
clearInterval(studyTimer);
studyRunning = false;
studySeconds = 25 * 60;
updateStudyTimerDisplay();
document.getElementById('study-timer-start').disabled = false;
document.getElementById('study-timer-pause').disabled = true;
}

document.getElementById('study-timer-start').addEventListener('click', startStudyTimer);
document.getElementById('study-timer-pause').addEventListener('click', pauseStudyTimer);
document.getElementById('study-timer-reset').addEventListener('click', resetStudyTimer);

// ======================
// TABS
// ======================
document.querySelectorAll('.tab').forEach(tab => {
tab.addEventListener('click', () => {
document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
document.querySelectorAll('#planner-view, #todo-view, #results-view, #study-timer-view').forEach(v => v.style.display = 'none');
tab.classList.add('active');
const view = tab.dataset.tab;
document.getElementById(`${view}-view`).style.display = 'block';
if (view === 'todo') {
renderTodo();
startCountdown();
}
if (view === 'results') {
if (isEditingResults) {
renderResultsEditable();
} else {
renderResults();
}
}
if (view === 'study-timer') {
updateStudyTimerDisplay();
}
});
});

// INIT
const todayStr = new Date().toISOString().split('T')[0];
document.getElementById('taskDate').value = todayStr;
document.getElementById('taskTime').value = '09:00';
buildGrid();
renderPlanner();
renderPalette();
applyZoom();
savePlanner();
renderTodo();
renderResults();
startCountdown();
updateStudyTimerDisplay();

// ======================
// MODAL HANDLERS FOR TODO EDIT
// ======================
document.getElementById('closeTaskModal').onclick = () => {
document.getElementById('taskModal').style.display = 'none';
};

document.getElementById('editTaskForm').onsubmit = (e) => {
e.preventDefault();
const id = document.getElementById('editTaskId').value;
const task = tasks.find(t => t.id == id);
if (!task) return;
const title = document.getElementById('editTaskTitle').value.trim();
const dateStr = document.getElementById('editTaskDate').value;
const timeStr = document.getElementById('editTaskTime').value;
if (!title || !dateStr || !timeStr) {
alert('Fill all fields');
return;
}
const due = new Date(`${dateStr}T${timeStr}`);
task.title = title;
task.due = due.getTime();
saveTasks();
renderTodo();
document.getElementById('taskModal').style.display = 'none';
};

document.getElementById('deleteTaskBtn').onclick = () => {
const id = document.getElementById('editTaskId').value;
if (confirm('Delete this task?')) {
tasks = tasks.filter(t => t.id != id);
saveTasks();
renderTodo();
document.getElementById('taskModal').style.display = 'none';
}
};

</script>
</body>
</html>
